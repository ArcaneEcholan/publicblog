---
title: 'Linux 虚拟桥接网络'
date: '2025-06-11'
tags: ['linux']
draft: false
summary:
---

# 三种 Linux 虚拟桥接拓扑结构记录

本文将通过三种典型有虚拟网桥参与的网络拓扑结构，结合数据流路径、路由参与机制、设备职责边界，理清虚拟桥接网络的本质。

---

## 基础概念回顾

### Linux 网桥/网卡 与系统网络协议栈

我一直有一个疑问：“网卡/网桥是不是就是接收 IP 层数据并封装成帧的模块？”

这个说法方向是对的，但需精确修正：

| 组成 | 是否属于网络协议栈 | 是否负责封装 IP 包 |
| --- | --- | --- |
| 操作系统协议栈（L3~L7） | 是 | 是（协议栈封装） |
| 物理网卡 | 否 | 否（只负责帧发/收） |
| 虚拟网桥/虚拟网卡（br0/vnet0） | 否（逻辑设备） | 否（只负责帧转发） |

封装 IP 为帧的逻辑在内核协议栈（L3→L2）内部完成，然后将帧通过 `net_device` 发给网卡/桥/虚拟设备。

虚拟网桥（如 `br0`）作为一种二层中继设备，本身不理解 IP，只根据 MAC 地址转发帧。

---

## 三种网络拓扑结构


### 拓扑结构 ：主机从 `eth0` 发包（错误或特殊）

`eth0` 不是桥的成员接口，该配置是PC机常用的网络配置。

```
curl → 查路由 → IP 绑定在 eth0 → 封装成帧并交给 eth0 → 网络
```

-   `eth0` 拥有 IP（如 192.168.1.10/24）

-   主机的路由表将默认网关绑定在 `eth0`

---

### 拓扑结构 ：主机通过 `br0` 发包

```
curl → 查路由 → IP 绑定在 br0 → 封装成帧并交给 br0 -> br0 把帧交给 eth0 → 网络
```

-   `br0` 拥有 IP（如 192.168.1.10/24）

-   `eth0` 无 IP，挂在 `br0` 下

-   主机的路由表将默认网关绑定在 `br0`

这是标准主机桥接配置。所有 IP 层通信通过 `br0` 封装转发。主机协议栈负责封装，`br0` 只是负责在L2层转发帧到物理网口。

---

### 拓扑结构 ：虚拟机通过 `vnet0 → br0 → eth0` 出网


```
虚拟机 curl → 虚拟机查路由 → IP 绑定在 vnet0 → 封装成帧并交给 vnet0 → vnet0 把帧交给 br0 -> br0 把帧交给 eth0 → 网络
```

-   虚拟机拥有独立 IP（如 192.168.1.100）

-   默认网关为物理网络的实际网关（如 192.168.1.1）

-   vnet0 桥接在 `br0` 上，br0 无需配置 IP，仅起转发作用


`br0` 作为透明的二层转发设备，虚拟机通过真实网关出网。虚拟机通信与宿主机无关，br0 无需 IP。

---

## br0 是否需要配置 IP？

| 使用场景 | br0 是否需要配置 IP |
| --- | --- |
| 主机主动发包（curl/ping） | 是 |
| 主机访问虚拟机（ssh/ping） | 是 |
| 虚拟机访问公网 | 否 |
| 虚拟机之间通信 | 否 |
| br0 仅作透明桥转发时 | 否 |

## 创建网桥并将物理设备桥接上

```bash
ip link add br0 type bridge
ip addr add 192.168.1.10/24 dev br0   # 如果主机需要参与网络层的通信（比如 ping 其他ip)
ip link set br0 up
ip link set eth0 master br0
ip link set eth0 up
```

---

## 对于上述桥接网络结构的配置总结

| 项目 | 说明 |
| --- | --- |
| br0 配 IP | 需要配置（主机参与通信时） |
| eth0 配 IP | 不需要配置（不应配置在桥接网口） |
| 虚拟机配置 IP | 需要配置 |
| 虚拟机默认网关 | 需要配置（应为物理网关） |
| 网卡/br0 收到的帧 | 封装由协议栈完成 |

---

## 协议栈职责和桥接设备行为边界

操作系统的协议栈是唯一的 IP→帧 封装者，网卡与网桥只是网络数据的“通道”。

涉及到网络层协议的操作（ping算，arp不算），都是先由操作系统协议栈查路由表（举例的一个具体操作），然后封装成帧，把帧交给网桥，网卡等。

所谓的在网卡或者网桥上配ip，以及路由表，实际上是操作系统的协议栈（ip层）的一种具体实现。

---
