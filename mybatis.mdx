---
title: 'mybatis'
date: '2025-09-21'
tags: ['java']
draft: false
summary:
---

## Mybatisplus å¢å¼ºåçš„ basemapper

æ™®é€š MyBatis æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ

å†™ä¸€ä¸ªæ¥å£ï¼š

```
@Mapper
public interface UserMapper {
    User selectById(Long id);
}
```

MyBatis ä¼šåœ¨å¯åŠ¨æ—¶è§£æå¯¹åº”çš„ UserMapper.xmlï¼ŒæŠŠ `<select id="selectById">` é‡Œçš„ SQL ç»‘å®šåˆ°è¿™ä¸ªæ¥å£çš„æ–¹æ³•ã€‚

æ‰§è¡Œæ—¶ï¼Œé€šè¿‡ Mapper åŠ¨æ€ä»£ç† (MapperProxy) æ‹¦æˆªæ–¹æ³•è°ƒç”¨ï¼Œæ‰¾åˆ° MappedStatementï¼Œç„¶åäº¤ç»™ Executor â†’ JDBC æ‰§è¡Œã€‚

æ ¸å¿ƒç‚¹ï¼šå¿…é¡»å†™ XMLï¼ˆæˆ–è€…æ³¨è§£ @Select ç­‰ï¼‰ã€‚

**plus å¢å¼º**

MyBatis-Plus çš„ç›®æ ‡æ˜¯ è®©ä½ ä¸ç”¨å†™ XML ä¹Ÿèƒ½æ‰§è¡Œå¸¸è§çš„ CRUDã€‚
æ‰€ä»¥å®ƒæä¾›äº†ä¸€ä¸ª `BaseMapper<T>` æ¥å£ï¼Œé‡Œé¢å®šä¹‰äº†ä¸€å †é€šç”¨æ–¹æ³•ï¼š
```
public interface BaseMapper<T> {
    T selectById(Serializable id);
    int insert(T entity);
    int updateById(T entity);
    int deleteById(Serializable id);
    // ...
}
```

ä½ è‡ªå·±çš„ Mapper åªéœ€è¦ç»§æ‰¿å®ƒï¼š

```
@Mapper
public interface UserMapper extends BaseMapper<User> {
}
```

ç„¶åï¼Œä½ å°±èƒ½ç›´æ¥å†™ï¼š

`userMapper.selectById(1L);`

## Mybatis æ ¸å¿ƒé€»è¾‘

### æµç¨‹

å‡è®¾æ˜¯ï¼š `usermapper.querybyname(String name)` è‡ªå®šä¹‰mapperæ–¹æ³•ï¼Œ

å¯ä»¥debug MybatisMapperMethod.execute(), å®Œäº†æ˜¯ executeForManyï¼Œè¿›å»åšä¸¤ä»¶äº‹å„¿ï¼š
* mapperæ–¹æ³•å‚æ•°è½¬æˆåˆé€‚çš„ç±»å‹ï¼ˆæ¯”å¦‚mapï¼Œmybatiså¾€é‡Œé¢æ”¾ç‚¹å„¿ç§æ´»,param1,param2ä»€ä¹ˆçš„ï¼‰
* sqlsession.selectlist ä»£ç†æ¥ä¸‹æ¥çš„æµç¨‹ã€‚

DefaultSqlSession.selectList

```
    MappedStatement ms = configuration.getMappedStatement(statement);
    return executor.query(ms, wrapCollection(param), RowBounds.DEFAULT, Executor.NO_RESULT_HANDLER);
```

ç¬¬ä¸€ä»¶äº‹å„¿å°±æ˜¯æ‹¿åˆ° msï¼ˆmappedstatementï¼‰ï¼Œè¿™ä¸ªä¸œè¥¿æ˜¯ mybatis é‡Œå¯¹æ¯æ¡ sql è¯­å¥çš„æŠ½è±¡ï¼Œé‡Œé¢æœ‰ sql idï¼Œsqlæ–‡æœ¬ï¼Œsqlç±»å‹ï¼ˆselect,update,insert,deleteï¼‰ï¼Œå‚æ•°ç±»å‹ï¼Œè¿”å›å€¼ç±»å‹ï¼Œresultmapç­‰ä¿¡æ¯ã€‚è¯´ç™½äº†å°±æ˜¯ä¸€ä¸ª app å¯åŠ¨ä¹‹åè§£æçš„æ¯æ¡ xml è¯­å¥å’Œ mapper æ³¨è§£è¯­å¥ç”Ÿæˆçš„ä¸€ä¸ªå¸¦æœ‰å ä½ç¬¦ä¿¡æ¯çš„sqlæ¨¡æ¿ã€‚ configuration.getMappedStatement(statement); è¿™ä¸ªé‡Œè¾¹å„¿å¯ä»¥çœ‹åˆ°ä¸€æºœè¿™æ ·çš„æ¨¡æ¿, xml, mapperæ¥å£çš„æ³¨è§£ï¼Œç¨‹åºå¯åŠ¨å°±è§£æå¥½äº†ï¼Œæ‰§è¡Œçš„æ—¶å€™ç›´æ¥ç”¨ï¼Œè¿™äº›ç”Ÿæˆ mappedstatements åˆ—è¡¨ï¼Œ

executor æ¥ç®¡ä¹‹åå°±æ˜¯ï¼Œå¯å¾—å‚æ•°ï¼š ms + paramsã€‚

ms åŒ…å«sqlä¿¡æ¯ï¼Œparams æ˜¯å…¥å‚ï¼Œæœ€ç»ˆç›®çš„æ˜¯æ¸²æŸ“sqlï¼Œè¯´ç™½äº†å°±æ˜¯åˆ›é€  preparedstatement ç„¶åæŠŠå‚æ•°è®¾ç½®äº†ã€‚

preparedstatement é  statementhandler ç”Ÿæˆï¼Œç„¶å å®ƒå†å§”æ‰˜ parameterhandler è®¾ç½®å‚æ•°ã€‚

ä¹‹åå°±æ˜¯æ‰§è¡Œäº†ã€‚

ä¸Šè¿°è¿‡ç¨‹ä¸­æœ‰å¾ˆå¤šæ’ä»¶ç‚¹ï¼Œæ²¡æ—¶é—´æ¢³ç†ã€‚

### å…³æ³¨æ¥å£ï¼š

https://mybatis.org/mybatis-3/configuration.html#plugins

MyBatis allows you to intercept calls to at certain points within the execution of a mapped statement. By default, MyBatis allows plug-ins to intercept method calls of:

* Executor  (update, query, flushStatements, commit, rollback, getTransaction, close, isClosed)
* ParameterHandler (getParameterObject, setParameters)
* ResultSetHandler (handleResultSets, handleOutputParameters)
* StatementHandler (prepare, parameterize, batch, update, query)

é‡ç‚¹å…³æ³¨ executor çš„å‚æ•°ã€‚ï¼ˆms + paramsï¼‰

ç”¨æ‹¦æˆªå™¨å»è§‚å¯Ÿä»–ä»¬ã€‚mybatis plus è‡ªå¸¦çš„çš„æ‹¦æˆªå™¨é»˜è®¤å°±ä¼šæ‹¦æˆªä»–ä»¬ï¼Œå¯ä»¥å¥½å¥½è§‚å¯Ÿä¸€ä¸‹ï¼Œä»€ä¹ˆæƒ…å†µï¼Œparams é•¿å•¥æ ·ã€‚å¯¹å®šåˆ¶å¾ˆæœ‰å¸®åŠ©ã€‚

### debug

ä¸¤æ¡è·¯ï¼šwrappers + mappers.

å¦‚å‚ç»‘å®šä¸­çš„typehandlerï¼šdebugè·¯å¾„æ¨èï¼šæ‹¦æˆªexecutor api

```
intercept(){

    interceptor.beforequery

    simpleexecutor::doquery

    simpleexecutor.prepareStatement

    handler.parameterize(stmt)

    ##execotor.query

    è¿”å›å€¼ç»‘å®šï¼š DefaultResultSetHandler.getPropertyMappingValue#typeHandler.getResult(rs, column)


    interceptor.afterquery

}
```

**åŸç†**: æ¯æ¡mapperè¯­å¥éƒ½ä¼šç¼–ç¨‹ä¸€æ¡boundsqlå¯¹è±¡ï¼Œå…¶ä¸­è®°å½•äº†ç»‘å®šåˆ°paramæˆ–è€…å®ä½“å­—æ®µçš„typehandlerã€‚setParameters é˜¶æ®µä¼šè°ƒç”¨è¿™äº›typehandlerã€‚

## typehandler ç»‘å®šï¼š

* å®ä½“å­—æ®µï¼š `@TableField(typeHandler = XxxTypeHandler.class)`. è¿™ç§æ–¹æ³•åªè¦ç¡®ä¿ç”¨çš„æ˜¯ä¸€ä¸ªå®ä½“ç±»ï¼Œèµ°çš„æ˜¯insert(entity) æˆ–è€… selectbyidï¼ˆentityï¼‰ä¹‹ç±»å°è£…å¥½çš„mapperæ–¹æ³•ï¼Œbasemapperé‡Œé¢ä¼šè‡ªåŠ¨è§£æã€‚å£°æ˜ç›Šå¤„å‡ºå‡ºç”Ÿæ•ˆã€‚
* mapperï¼šè¿™ç§åˆ†ä¸ºä¸€ä¸‹ä¸¤ç§å…·ä½“æ–¹å¼ï¼Œéœ€è¦åœ¨ç”¨åˆ°çš„åœ°æ–¹éƒ½æ˜¾ç¤ºå£°æ˜typehandlerï¼Œæ— è®ºæ˜¯å…¥å‚è¿˜æ˜¯è¿”å›å€¼ã€‚
* mapperå‚æ•°ï¼ˆæˆ–è€…è¿”å›åªï¼‰ï¼š
```
    // è¿™ä¸ªå¯ä»¥ç”¨æ³¨è§£çš„æ–¹å¼å®šä¹‰ï¼Œè¿™é‡Œä¸å†™äº†æ¯”è¾ƒéº»çƒ¦
    <resultMap id="PatientInfoMap" type="com.example.projects__springportable.PatientInformationDto">
        <id property="id" column="id"/>
        <result property="name" column="name" typeHandler="com.example.projects__springportable.AesEncryptHandler"/>
<!--        <result property="phone" column="phone" typeHandler="com.example.projects__springportable.AesEncryptHandler"/>-->
<!--        <result property="address" column="address" typeHandler="com.example.projects__springportable.AesEncryptHandler"/>-->
        <!-- å…¶ä»–ä¸éœ€è¦åŠ å¯†çš„å­—æ®µç…§å¸¸æ˜ å°„ -->
    </resultMap>
    @Select("SELECT * FROM patient WHERE name = #{name, typeHandler=com.example.projects__springportable.AesEncryptHandler}")
    @ResultMap("PatientInfoMap")
    List<PatientInformationDto> getByName(@Param("name") String name);
```
* mapperxml:
```xml
    <resultMap id="PatientInfoMap" type="com.example.projects__springportable.PatientInformationDto">
        <id property="id" column="id"/>
        <result property="name" column="name" typeHandler="com.example.projects__springportable.AesEncryptHandler"/>
<!--        <result property="phone" column="phone" typeHandler="com.example.projects__springportable.AesEncryptHandler"/>-->
<!--        <result property="address" column="address" typeHandler="com.example.projects__springportable.AesEncryptHandler"/>-->
        <!-- å…¶ä»–ä¸éœ€è¦åŠ å¯†çš„å­—æ®µç…§å¸¸æ˜ å°„ -->
    </resultMap>
    <select id="getByName" resultMap="PatientInfoMap">
        SELECT * FROM patient WHERE name = #{name, typeHandler=com.example.projects__springportable.AesEncryptHandler}
    </select>
```

# boundsql

### ğŸ”¹ `BoundSql` çš„å®šä¹‰

`org.apache.ibatis.mapping.BoundSql`
é‡Œé¢ä¸»è¦æœ‰è¿™å‡ ä¸ªå…³é”®å†…å®¹ï¼š

1. **sql**

    * æœ€ç»ˆè¦äº¤ç»™ JDBC æ‰§è¡Œçš„ SQL è¯­å¥ï¼ˆåŒ…å« `?` å ä½ç¬¦ï¼‰ã€‚

    * æ¯”å¦‚ä½ å†™çš„ï¼š

        ```xml
        <select id="findUser" parameterType="int" resultType="User">
          select * from user where id = #{id}
        </select>
        ```

        * åœ¨ `BoundSql` é‡Œä¼šå˜æˆï¼š

            ```sql
            select * from user where id = ?
            ```

2. **parameterObject**

    * ä¼ å…¥çš„å‚æ•°å¯¹è±¡ï¼ˆæ¯”å¦‚ `id=123`ï¼‰ã€‚

3. **parameterMappings**

    * è®°å½•äº†æ¯ä¸ª `?` å¯¹åº”çš„å‚æ•°ä¿¡æ¯ï¼ˆåç§°ã€JDBC ç±»å‹ã€å¤„ç†å™¨ï¼‰ã€‚

    * æ¯”å¦‚ä¸Šé¢çš„ SQL å°±ä¼šæœ‰ä¸€ä¸ª `ParameterMapping("id", Integer.class)`ã€‚

4. **additionalParameters**

    * é™„åŠ å‚æ•°ï¼Œæ¯”å¦‚åŠ¨æ€ SQLï¼ˆ`<foreach>`ã€`<bind>`ï¼‰äº§ç”Ÿçš„ä¸´æ—¶å˜é‡ã€‚


* * *

### ğŸ”¹ ä½œç”¨

å¯ä»¥ç†è§£ä¸ºï¼š

* **MappedStatement** â†’ SQL æ¨¡æ¿ï¼ˆå¸¦ `#{}` å ä½ç¬¦ï¼‰ã€‚

* **BoundSql** â†’ ç»‘å®šå‚æ•°ä¹‹åçš„ SQLï¼ˆå¸¦ `?` å ä½ç¬¦ï¼Œå‚æ•°æ˜ å°„ä¿¡æ¯éƒ½åœ¨é‡Œé¢ï¼‰ã€‚


æ‰€ä»¥ MyBatis æ‰§è¡Œ SQL çš„æµç¨‹å¤§æ¦‚æ˜¯ï¼š

1. æ ¹æ® `MappedStatement` å’Œå‚æ•°å¯¹è±¡ç”Ÿæˆ `BoundSql`ã€‚

2. `StatementHandler` ç”¨ `BoundSql` é‡Œçš„ SQL + å‚æ•°æ˜ å°„ï¼Œè®¾ç½®åˆ° `PreparedStatement`ã€‚

3. JDBC æ‰§è¡Œ SQLã€‚


* * *

### ğŸ”¹ ä¸¾ä¸ªä¾‹å­

å‡è®¾ä½ è°ƒç”¨ï¼š

```java
mapper.findUser(123);
```

* `MappedStatement`ï¼š

    ```sql
    select * from user where id = #{id}
    ```

* `BoundSql`ï¼š

    * sql:

        ```sql
        select * from user where id = ?
        ```

    * parameterObject: `123`

    * parameterMappings: `[id â†’ Integer]`


æœ€ç»ˆ JDBC æ‰§è¡Œçš„æ˜¯ï¼š

```sql
select * from user where id = 123;
```
