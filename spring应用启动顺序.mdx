---
title: 'springåº”ç”¨å¯åŠ¨é¡ºåº'
date: '2025-10-03'
tags: ['java', 'springboot', 'tomcat']
draft: false
---

# onrefresh

æˆ‘ä»¬æ¥æŠŠ **`onRefresh()` çš„æ¥å†å’Œæ—¶æœº** è®²æ¸…æ¥šï¼š


**`onRefresh()` å±äºå“ªä¸ªæ¥å£/ç±»**

* `onRefresh()` **ä¸æ˜¯æ¥å£æ–¹æ³•**ï¼Œè€Œæ˜¯ `AbstractApplicationContext` å®šä¹‰çš„ä¸€ä¸ª **protected é’©å­æ–¹æ³•**ã€‚

* å®ƒçš„å£°æ˜ï¼š

    ```java
    protected void onRefresh() throws BeansException {
        // For subclasses: do nothing by default.
    }
    ```

* é»˜è®¤å®ç°æ˜¯ç©ºçš„ï¼Œ**å­ç±»å¯ä»¥è¦†ç›–å®ƒ**ï¼Œåœ¨ `refresh()` æµç¨‹ä¸­æ·»åŠ ç‰¹å®šé€»è¾‘ã€‚


**webå®¹å™¨å‡†å¤‡å¥½æœåŠ¡å‘ç”Ÿåœ¨`onRefresh()`æ¥å£**

åœ¨ Spring Boot é‡Œï¼š

* `ServletWebServerApplicationContext` **é‡å†™äº† onRefresh()**ï¼Œç”¨æ¥å¯åŠ¨å†…åµŒ WebServerã€‚

å¯åŠ¨æµç¨‹ï¼ˆServlet ç¯å¢ƒï¼ŒTomcat ä¸ºä¾‹ï¼‰

1. **å®¹å™¨ refresh() é˜¶æ®µ**
    Spring åœ¨ `AbstractApplicationContext.refresh()` â†’ `finishRefresh()` æ—¶ï¼Œä¼šè°ƒç”¨å­ç±»çš„ `onRefresh()`ã€‚

    åœ¨ **`ServletWebServerApplicationContext.onRefresh()`** é‡Œï¼š

    ```java
    protected void onRefresh() {
        super.onRefresh();
        try {
            createWebServer();
        }
        catch (Throwable ex) {
            throw new ApplicationContextException("Unable to start web server", ex);
        }
    }
    ```

2. **åˆ›å»º WebServer**
    `createWebServer()` è°ƒç”¨ `ServletWebServerFactory`ï¼ˆæ¯”å¦‚ `TomcatServletWebServerFactory`ï¼‰æ¥æ„é€ ä¸€ä¸ª `WebServer`ï¼š

    ```java
    this.webServer = factory.getWebServer(getSelfInitializer());
    ```

    * `ServletWebServerFactory` æ˜¯ **Spring Boot å®šä¹‰çš„æ¥å£**ï¼ˆæŠ½è±¡åŒ–ä¸åŒå®¹å™¨ï¼šTomcat/Jetty/Undertowï¼‰ã€‚

    * `getWebServer(...)` ä¼šè¿”å›ä¸€ä¸ª `TomcatWebServer` å®ä¾‹ã€‚

 Tomcat å¯åŠ¨ä¸ `WebServerInitializedEvent`

* å¦‚æœæ˜¯ Web åº”ç”¨ï¼Œ`ServletWebServerApplicationContext` åœ¨ `refresh()` çš„ **onRefresh()** é˜¶æ®µä¼šè°ƒç”¨ `createWebServer()`ï¼š

    * åˆ›å»ºå¹¶å¯åŠ¨ Tomcat/Jetty/Undertow å®ä¾‹ï¼ˆåº•å±‚è°ƒç”¨ `Tomcat.start()`ï¼‰ã€‚

    * ç»‘å®šç«¯å£ â†’ Connector å¯æ¥å—è¯·æ±‚ã€‚

    * **è¿™ä¹‹åå‘å¸ƒ WebServerInitializedEvent**ï¼ˆå‘Šè¯‰ä½  web server å·²ç» readyï¼Œå¯ä»¥æ‹¿åˆ°ç«¯å£ï¼‰ã€‚

æ€»ç»“

**`onRefresh()`ï¼ˆå¯åŠ¨å¹¶è¿è¡Œ WebServer â†’ Tomcat ç«¯å£å¼€æ”¾ï¼‰ â†’ `finishBeanFactoryInitialization(...)`ï¼ˆå®Œæˆå•ä¾‹å®ä¾‹åŒ–ï¼‰ â†’ `SmartInitializingSingleton.afterSingletonsInstantiated()`**

æœ€å°å¯éªŒè¯ Demoï¼ˆè‡ªå·±è·‘ä¸€éå°±èƒ½çœ‹åˆ°é¡ºåºï¼‰

```java
@SpringBootApplication
public class DemoApp {

  public static void main(String[] args) {
    SpringApplication.run(DemoApp.class, args);
  }

  // ç›‘å¬â€œWebServer å·²å°±ç»ªâ€
  @Bean
  ApplicationListener<org.springframework.boot.web.servlet.context.ServletWebServerInitializedEvent> webReady() {
    return evt -> System.out.println(">>> WEB READY, port=" + evt.getWebServer().getPort());
  }

  // SmartInitializingSingletonï¼šåœ¨â€œæ‰€æœ‰å•ä¾‹éƒ½å®ä¾‹åŒ–å®Œâ€ä¹‹åæ‰è§¦å‘
  @Bean
  org.springframework.beans.factory.SmartInitializingSingleton sisBean() {
    return () -> System.out.println(">>> SIS afterSingletonsInstantiated()");
  }
}
```

æ­£å¸¸æƒ…å†µä¸‹ä½ ä¼šåœ¨æ§åˆ¶å°çœ‹åˆ° **`WEB READY`** å…ˆæ‰“å°ï¼Œ**`SIS afterSingletonsInstantiated()`** åæ‰“å°ï¼Œä»è€Œç›´æ¥éªŒè¯â€œ**Tomcat ready åœ¨å‰ï¼ŒSmartInitializingSingleton åœ¨å**â€ã€‚

ä»€ä¹ˆæ—¶å€™ç”¨å“ªä¸ªå›è°ƒ

* æƒ³åœ¨**ç«¯å£å·²å¼€æ”¾**ååšäº‹ï¼ˆä¾‹å¦‚æš´éœ²å‡ºæ¥çš„ä¾èµ–éœ€è¦å¯è®¿é—®ï¼‰ï¼š
    ç›‘å¬ **`ServletWebServerInitializedEvent`** æˆ–ç”¨ **`ApplicationReadyEvent`**ã€‚[Home+1](https://docs.spring.io/spring-boot/3.4.0/api/java/org/springframework/boot/web/servlet/context/ServletWebServerInitializedEvent.html?utm_source=chatgpt.com)

* æƒ³åœ¨**æ‰€æœ‰å•ä¾‹ bean éƒ½åˆ›å»ºå®Œ**ä½†**ä¸ä¾èµ–ç«¯å£å°±ç»ª**æ—¶åšåˆå§‹åŒ–ï¼š
    ç”¨ **`SmartInitializingSingleton`**ã€‚[Home](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/beans/factory/SmartInitializingSingleton.html?utm_source=chatgpt.com)


å®˜æ–¹æ–‡æ¡£é“¾æ¥

* **`AbstractApplicationContext` æ—¶åºï¼ˆ`onRefresh` åœ¨â€œå•ä¾‹å®ä¾‹åŒ–ä¹‹å‰â€ï¼‰**
    [https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/context/support/AbstractApplicationContext.html](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/context/support/AbstractApplicationContext.html?utm_source=chatgpt.com) [Home](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/context/support/AbstractApplicationContext.html)

* **`ServletWebServerApplicationContext`ï¼ˆåˆ›å»ºã€åˆå§‹åŒ–å¹¶è¿è¡Œ WebServerï¼‰**
    https://docs.spring.io/spring-boot/3.4/api/java/org/springframework/boot/web/servlet/context/ServletWebServerApplicationContext.html [Home](https://docs.spring.io/spring-boot/3.4.6/api/java/org/springframework/boot/web/servlet/context/ServletWebServerApplicationContext.html)

* **`SmartInitializingSingleton` å®šä¹‰**
    [https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/beans/factory/SmartInitializingSingleton.html](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/beans/factory/SmartInitializingSingleton.html?utm_source=chatgpt.com) [Home](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/beans/factory/SmartInitializingSingleton.html?utm_source=chatgpt.com)

* **`ServletWebServerInitializedEvent` è¯­ä¹‰**
    [https://docs.spring.io/spring-boot/3.4.0/api/java/org/springframework/boot/web/servlet/context/ServletWebServerInitializedEvent.html](https://docs.spring.io/spring-boot/3.4.0/api/java/org/springframework/boot/web/servlet/context/ServletWebServerInitializedEvent.html?utm_source=chatgpt.com) [Home](https://docs.spring.io/spring-boot/3.4.0/api/java/org/springframework/boot/web/servlet/context/ServletWebServerInitializedEvent.html?utm_source=chatgpt.com)


**`onRefresh()` è°ƒç”¨æ—¶æœº**

åœ¨ `AbstractApplicationContext.refresh()` æ–¹æ³•ä¸­ï¼Œå®ƒè¢«è°ƒç”¨åœ¨ **bean åˆå§‹åŒ–å®Œæˆä¹‹å**ï¼Œä½†ä¸æ˜¯æœ€åä¸€æ­¥ã€‚

ç²¾ç¡®é¡ºåºï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š

```java
public void refresh() {
    prepareRefresh();                 // å‡†å¤‡ç¯å¢ƒ
    ConfigurableListableBeanFactory bf = obtainFreshBeanFactory();
    prepareBeanFactory(bf);

    postProcessBeanFactory(bf);
    invokeBeanFactoryPostProcessors(bf);
    registerBeanPostProcessors(bf);
    initMessageSource();
    initApplicationEventMulticaster();

    onRefresh();                      // <<<<<<<<<< è¿™é‡Œè¢«è°ƒç”¨

    registerListeners();
    finishBeanFactoryInitialization(bf);   // å®ä¾‹åŒ–å‰©ä½™çš„å•ä¾‹ bean
    finishRefresh();                  // å‘å¸ƒäº‹ä»¶ï¼Œè°ƒç”¨ Lifecycle
}
```

**3. æ—¶åºç‰¹ç‚¹**

* **onRefresh ä½ç½®**ï¼š

    * åœ¨ `BeanFactoryPostProcessor`ã€`BeanPostProcessor` æ³¨å†Œå®Œæˆä¹‹å

    * åœ¨æ‰€æœ‰ **å•ä¾‹ Bean åˆå§‹åŒ–ä¹‹å‰**

    * åœ¨äº‹ä»¶ç›‘å¬å™¨æ³¨å†Œä¹‹å‰

* **Spring Boot çš„ç”¨æ³•**ï¼š

    * `ServletWebServerApplicationContext.onRefresh()` ä¼šè°ƒç”¨ `createWebServer()`ï¼Œæå‰å¯åŠ¨ WebServerã€‚

    * è¿™æ ·åç»­å•ä¾‹ beanï¼ˆæ¯”å¦‚ DispatcherServletã€Filterï¼‰åˆå§‹åŒ–æ—¶ï¼Œå·²ç»æœ‰äº† `ServletContext` å¯ä»¥æ³¨å†Œåˆ° Tomcat é‡Œã€‚

# bean åˆå§‹åŒ–å‘ç”Ÿåœ¨å“ªé‡Œã€‚

`refresh()` çš„å¤§æµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰

```text
refresh() {
  prepareRefresh()
  obtainFreshBeanFactory()
  prepareBeanFactory()
  postProcessBeanFactory()
  invokeBeanFactoryPostProcessors()
  registerBeanPostProcessors()
  initMessageSource()
  initApplicationEventMulticaster()

  onRefresh()   <-- Spring Boot WebServer åœ¨è¿™é‡Œå¯åŠ¨

  registerListeners()
  finishBeanFactoryInitialization()   <-- çœŸæ­£è§¦å‘ Bean å®ä¾‹åŒ–
  finishRefresh()
}
```

ğŸ‘‰ é‡ç‚¹ï¼š

* **Bean çš„å®ä¾‹åŒ–ï¼ˆåŒ…æ‹¬æ„é€ ã€ä¾èµ–æ³¨å…¥ã€ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼‰å¹¶ä¸æ˜¯åœ¨ onRefresh() é˜¶æ®µæ‰§è¡Œçš„**ï¼Œè€Œæ˜¯åœ¨ **finishBeanFactoryInitialization()** é˜¶æ®µè§¦å‘çš„ã€‚

* `onRefresh()` æ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡çº§åˆ«çš„é’©å­ç‚¹ï¼Œä¸»è¦è®©å­ç±»æœ‰æœºä¼šåœ¨ **Bean çœŸæ­£åˆ›å»ºä¹‹å‰**åšä¸€äº›é¢å¤–å‡†å¤‡ï¼ˆWebServer å°±åœ¨è¿™ä¸€æ­¥å¯åŠ¨ï¼‰ã€‚

2. Bean çš„ç”Ÿå‘½å‘¨æœŸï¼ˆå‘ç”Ÿåœ¨ finishBeanFactoryInitialization é˜¶æ®µï¼‰

å½“å®¹å™¨èµ°åˆ° `finishBeanFactoryInitialization(beanFactory)` æ—¶ï¼Œä¼šé€ä¸ªåˆ›å»ºå•ä¾‹ beanï¼Œæµç¨‹å¤§è‡´æ˜¯ï¼š

1. **å®ä¾‹åŒ–**

    * æ„é€ æ–¹æ³•ï¼ˆConstructor æˆ– FactoryMethodï¼‰

2. **ä¾èµ–æ³¨å…¥**

    * è®¾ç½®å±æ€§ï¼Œè‡ªåŠ¨è£…é…

3. **BeanPostProcessor â€” Before**

    * è°ƒç”¨æ‰€æœ‰æ³¨å†Œçš„ `BeanPostProcessor.postProcessBeforeInitialization(bean, beanName)`

4. **åˆå§‹åŒ–æ–¹æ³•**

    * `@PostConstruct`

    * `afterPropertiesSet()` (InitializingBean æ¥å£)

    * è‡ªå®šä¹‰ init-methodï¼ˆå¦‚æœé…ç½®äº†ï¼‰

5. **BeanPostProcessor â€” After**

    * è°ƒç”¨æ‰€æœ‰æ³¨å†Œçš„ `BeanPostProcessor.postProcessAfterInitialization(bean, beanName)`

6. **æ‰€æœ‰å•ä¾‹ bean éƒ½å®Œæˆå**

    * æ‰§è¡Œ `SmartInitializingSingleton.afterSingletonsInstantiated()`

    * å‘å¸ƒ `ContextRefreshedEvent`

3. ä¸¤è€…å…³ç³»æ€»ç»“ï¼ˆonRefresh vs Bean ç”Ÿå‘½å‘¨æœŸï¼‰

* **onRefresh()**

    * å‘ç”Ÿåœ¨ **Bean å®ä¾‹åŒ–ä¹‹å‰**

    * ç”¨äºå­ç±» ApplicationContext çš„æ‰©å±•ï¼ˆSpring Boot Web åœºæ™¯ä¸‹å¯åŠ¨å†…åµŒ WebServerï¼‰ã€‚

* **Bean ç”Ÿå‘½å‘¨æœŸï¼ˆæ„é€  â†’ æ³¨å…¥ â†’ BPP.before â†’ init â†’ BPP.afterï¼‰**

    * å‘ç”Ÿåœ¨ `finishBeanFactoryInitialization()` é˜¶æ®µ

    * åªæœ‰åˆ°è¿™ä¸€æ­¥ï¼Œæ‰å¼€å§‹é€ä¸ªåˆ›å»ºå’Œåˆå§‹åŒ– Beanã€‚

* é¡ºåºå›¾å¤§æ¦‚æ˜¯ï¼š


```text
refresh()
  â”œâ”€â”€ ... BeanFactoryPostProcessor ...
  â”œâ”€â”€ registerBeanPostProcessors()
  â”œâ”€â”€ onRefresh()   <-- WebServer åœ¨è¿™é‡Œå¯åŠ¨
  â”œâ”€â”€ registerListeners()
  â”œâ”€â”€ finishBeanFactoryInitialization()
  â”‚     â”œâ”€â”€ å®ä¾‹åŒ– bean (æ„é€ )
  â”‚     â”œâ”€â”€ ä¾èµ–æ³¨å…¥
  â”‚     â”œâ”€â”€ BeanPostProcessor.before
  â”‚     â”œâ”€â”€ @PostConstruct / afterPropertiesSet / init-method
  â”‚     â”œâ”€â”€ BeanPostProcessor.after
  â”‚     â””â”€â”€ ...
  â”œâ”€â”€ finishRefresh()
        â”œâ”€â”€ SmartInitializingSingleton.afterSingletonsInstantiated()
        â”œâ”€â”€ å‘å¸ƒ ContextRefreshedEvent
        â””â”€â”€ ...
```

# refresh ä¹‹å

**Runner & ApplicationReadyEvent** æ”¾åˆ°å‰é¢æ•´ç†çš„æ—¶åºé‡Œï¼š

```text
refresh()
  â”œâ”€â”€ ... BeanFactoryPostProcessor ...
  â”œâ”€â”€ registerBeanPostProcessors()
  â”œâ”€â”€ onRefresh()                           <-- WebServer åˆ›å»º
  â”œâ”€â”€ registerListeners()
  â”œâ”€â”€ finishBeanFactoryInitialization()
  â”‚     â”œâ”€â”€ Bean æ„é€  + æ³¨å…¥
  â”‚     â”œâ”€â”€ BeanPostProcessor.before
  â”‚     â”œâ”€â”€ @PostConstruct / afterPropertiesSet / init-method
  â”‚     â”œâ”€â”€ BeanPostProcessor.after
  â”‚     â””â”€â”€ ...
  â”œâ”€â”€ finishRefresh()
  â”‚     â”œâ”€â”€ SmartInitializingSingleton.afterSingletonsInstantiated()
  â”‚     â”œâ”€â”€ å‘å¸ƒ ContextRefreshedEvent
  â”‚     â”œâ”€â”€ WebServerStartStopLifecycle.start() â†’ WebServerInitializedEvent
  â”‚     â””â”€â”€ ...
  â””â”€â”€ refresh() ç»“æŸ
  â”‚
  â”œâ”€â”€ å‘å¸ƒ ApplicationStartedEvent
  â”œâ”€â”€ æ‰§è¡Œ ApplicationRunner
  â”œâ”€â”€ æ‰§è¡Œ CommandLineRunner
  â””â”€â”€ å‘å¸ƒ ApplicationReadyEvent
```

* * *

##  æ€»ç»“

* **CommandLineRunner / ApplicationRunner**ï¼šå‘ç”Ÿåœ¨æ•´ä¸ª `refresh()` å®Œæˆä¹‹åï¼Œç”± `SpringApplication` è°ƒç”¨ã€‚

* **ApplicationReadyEvent**ï¼šåœ¨ Runner æ‰§è¡Œå®Œåå‘å¸ƒï¼Œæ˜¯â€œåº”ç”¨å®Œå…¨å°±ç»ªâ€çš„æ ‡å¿—ã€‚

* **ApplicationStartedEvent**ï¼šåœ¨ Runner ä¹‹å‰ï¼Œè¡¨ç¤ºå®¹å™¨å·²ç» refresh å®Œæˆï¼ŒWebServer ä¹Ÿèµ·æ¥äº†ã€‚
